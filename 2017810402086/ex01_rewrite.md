# ex01_rewrite

> 打开淘宝和京东主页，分别在搜索关键字输入 耳机，点击搜索按钮，分析浏览器发送给服务器的请求内容和响应结果，完成下面的报告。

## 淘宝

1. 单击搜索框
    * 该操作一次发起2个请求，请求链接相同但请求参数及请求目的不同

    * 请求1
        * 每次打开网页时，该请求只会在第一次单击搜索框时触发
        * 请求链接
            * <https://suggest.taobao.com/sug>
        * 请求参数
            1. _ksTS
                * 1570450125221_292
                * 时间戳
            2. callback
                * jsonp293
                * 使用jsonp时的callback参数
            3. area
                * history_magic
                * 请求内容所在领域，此处为历史记录
            4. q
                * 手机耳机
                * 此处为本地搜索过的关键字的记录，""用于分割
            5. bucketid
                * 10
                * 分组id，用途未知
        * 响应结果

            ```json
            jsonp293({"result":[]})
            ```

            响应结果是一个用jsonp包裹的对象，内部有一个名为result的空数组
        * 该请求只把本地历史搜索记录传至服务器端，而服务器端仅返回空值，猜测只是为了搜集本地搜索的历史记录所发出的请求

    * 请求2
        * 该请求即输入搜索关键字时触发的请求，只是搜索关键字为空

2. 输入搜索关键字
    * 搜索框中出现之前没出现过的字符串时就会发起一次请求，出现之前出现过的字符串时则调用之前请求结果
    * 请求链接
        * <https://suggest.taobao.com/sug>
    * 请求参数
        1. code
            * utf-8
            * 编码格式
        2. q
            * 耳机
            * 搜索关键字
        3. _ksTS
            * 1570451697782_393
            * 时间戳
        4. callback
            * jsonp394
            * 使用jsonp时的callback参数
        5. k
            * 1
            * 用途未知
        6. area
            * c2c
            * 请求内容所在领域，此处为c2c，"个人与个人之间的电子商务"
        7. bucketid
            * 10
            * 分组id，用途未知
    * 响应结果

        ```json
        jsonp394({
            "result":[
                ["耳机入耳式","4923599.972171796"],
                ["耳机蓝牙","418971.8350204727"],
                ["耳机套","383660.038276726"],
                ["耳机套 airpods","231811.22075389948"],
                ["耳机头戴式","100307.60954665819"],
                ["耳机壳","211758.1676032468"],
                ["耳机保护套","342769.3700714256"],
                ["耳机壳 airpods","197511.76342394968"],
                ["耳机无线","393299.0096770738"],
                ["耳机保护套airpods","207080.07492323438"]
            ],
            "magic":[
                {
                    "index":"1",
                    "type":"tag_group",
                    "data":[
                        [
                            {"title":"小米"},
                            {"title":"MIUI\/小米","type":"hot"}
                        ],
                        [
                            {"title":"魔声","type":"hot"},
                            {"title":"三星"},
                            {"title":"通用"},
                            {"title":"耳塞式"},
                            {"title":"漫步者"},
                            {"title":"索尼"},
                            {"title":"苹果"},
                            {"title":"重低音"}
                        ]
                    ]
                },
                {
                    "index":"2",
                    "type":"tag_group",
                    "data":[
                        [
                            {"title":"挂耳式","type":"hot"},
                            {"title":"耳塞式"},
                            {"title":"头戴式"}
                        ],
                        [
                            {"title":"防水"},
                            {"title":"无线"},
                            {"title":"魅族"},
                            {"title":"苹果"},
                            {"title":"华为"},
                            {"title":"三星","type":"hot"},
                            {"title":"智能"}
                        ]
                    ]
                },
                {
                    "index":"9",
                    "type":"tag_group",
                    "data":[
                        [
                            {"title":"耳塞式"},
                            {"title":"挂耳式","type":"hot"},
                            {"title":"头戴式"}
                        ],
                        [
                            {"title":"索尼"},
                            {"title":"蓝牙"},
                            {"title":"苹果"},
                            {"title":"电脑"},
                            {"title":"三星","type":"hot"},
                            {"title":"华为"},
                            {"title":"智能"}
                        ]
                    ]
                }
            ]
        })
        ```

        主要分为2个数组result和magic。result是普通的搜索建议结果，每个结果都由一个数组包装，包含一个结果内容和一串数字，数字用途未知。magic则是在下拉显示的搜索结果建议中鼠标悬停时能在右侧显示的更多内容。此请求的magic中有3个对象，每个对象都有index、type、data3个数据。index对应result中结果的数组id，type表明数据类型，data则是在右侧显示的具体数据。data数组内包含2个数组，每个数组的显示是分开的，数组内对象的title是显示的内容，有```"type":"hot"```数据的对象显示的字是红色的。

3. 点击搜索按钮
    * 只发起一个请求
    * 请求链接
        * <https://s.taobao.com/search>
    * 请求参数
        1. q
            * 耳机
            * 查询关键字
        2. imgfile
            * (空值)
            * 可能是查询用的图片文件
        3. commend
            * all
            * 不清楚
        4. ssid
            * s5-e
            * 不清楚
        5. search_type
            * item
            * 搜索对象类型
        6. sourceId
            * tb.index
            * 资源id
        7. spm
            * a21bo.2017.201856-taobao-item.1
            * 导购效果跟踪，参考
                > <https://open.taobao.com/doc.htm?docId=959&docType=1>
        8. ie
            * utf8
            * 不清楚，猜测可能是浏览器的字符类型？
        9. initiative_id
            * tbindexz_20170306
            * 不清楚
    * 响应结果
        * doc类型，为html，内容是网页的框架部分、用于加载后续内容的js脚本和cdn链接

## 京东

1. 单击搜索框
    * 发起一个请求，且每次焦点位于搜索框且搜索框内无字符时都会触发此请求
    * 请求链接
        * <https://hiswd.jd.com/>
    * 请求参数
        1. pvid
            * c7c75d82764949969e6a483269b8ae88
            * 应该为前端id，每次打开页面便会重新生成一次
        2. callback
            * jQuery8846098
            * 用jQuery实现jsonp跨域请求时需要的callback
    * 响应结果

        ```json
        jQuery8846098(
            [
                {"his":"1","key":"耳机"},
                {"his":"1","key":"京东"}
            ]
        )
        ```

        返回为一个对象数组，每个对象都有his和key两个数据。his意义不明，可能是指是否为当前用户的搜索记录，key则是历史搜索记录的内容
2. 输入搜索关键字
    * 搜索框中的字符只要发生变化，就会触发此请求
    * 请求链接
        * <https://dd-search.jd.com/>
    * 请求参数
        1. terminal
            * pc
            * 请求终端类型，此处为pc
        2. newjson
            * 1
            * 新json，为1可能是启用此类型的数据格式
        3. ver
            * 2
            * 版本，不清楚具体指什么的版本
        4. zip
            * 1
            * 可能为压缩选项，1应该为启用
        5. key
            * 耳机
            * 搜索关键字
        6. pvid
            * 07220cfbb23043d5b3a0f2511fb57188
            * 应该为前端id，每次打开页面便会重新生成一次
        7. t
            * 1570456147186
            * 时间戳
        8. curr_url
            * www.jd.com/
            * 发起请求时的地址
        9. callback
            * jQuery5991139
            * 用jQuery实现jsonp跨域请求时需要的callback
    * 响应结果

        ```json
        jQuery5991139([
            {"key":"耳机 plus尊享","qre":"9172"},
            {"key":"耳机蓝牙","qre":"612781"},
            {"key":"耳机有线","qre":"199917"},
            {"key":"耳机头戴式","qre":"135855"},
            {"key":"耳机无线","qre":"496139"},
            {"key":"耳机自营","qre":"8945"},
            {"key":"耳机苹果","qre":"513930"},
            {"key":"耳机华为","qre":"13122"},
            {"key":"耳机电脑","qre":"196967"},
            {"key":"耳机入耳式","qre":"301446"},
            {"key":"耳机带麦","qre":"198372"},
            {"key":"耳机骨传导","qre":"15317"},
            {"key":"耳机蓝牙运动","qre":"282510"},
            {"version":"V09--12s0,20s0,38s0,97s0"}
        ])
        ```

        对象数组，包括结果内容对象和版本对象。结果内容对象内有key和qre两个数据，key是显示的内容，不清楚qre具体是什么。版本对象只有一个version数据用来指示版本编号，可能指的是jsonp格式的版本。

3. 点击搜索按钮
    * 只发起一个请求
    * 请求链接
        * <https://search.jd.com/Search>
    * 请求参数
        1. keyword
            * 耳机
            * 搜索关键字
        2. enc
            * utf-8
            * 字符编码类型
        3. wq
            * 耳机
            * 搜索框中的文本，如果是通过单击搜索建议进行搜索，此参数值为空
        4. pvid
            * 109529e81e5d46d89eca7de80cc376d5
            * 应该为前端id，每次打开页面便会重新生成一次
    * 响应结果
        * doc类型，为html，内部包含网页框架，用于请求后续内容的js脚本，已经部分预先加载的商品信息。

## 对比

1. 键入搜索框时的部分
    * 很明显能看出，淘宝在尽可能的减少用户的请求次数，淘宝不会从服务器端获取历史记录，搜索建议只要请求过一次就不会再次请求；京东则是只判断搜索框字符串是否变化，如有变化就请求，不考虑利用之前请求到的数据。同时淘宝的搜索建议包含更多的内容。在数据格式上，为了实现跨域请求，淘宝直接使用了jsonp，京东则是使用jQuery包装的jsonp。
2. 点击搜索的部分
    * 淘宝的请求参数数量明显多于京东，其中很明显能看到淘宝独有的技术(如spm，顺带一提淘宝的响应头中的eagleeye-traceid参数也是淘宝独有的技术，用于前后端链路追踪)。双方都直接返回doc，并把其余内容放在了后续加载中。淘宝后续加载的只有doc类型的文件，京东则是xhr和doc兼有。
